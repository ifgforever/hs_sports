<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Mission • Mission Channels</title>
  <link rel="stylesheet" href="/assets/style.css">
</head>
<body>
<header>
  <div class="wrap">
    <nav>
      <div class="navlinks">
        <a class="btn primary" href="/index.html">Mission Channels</a>
        <a class="btn" href="/browse.html">Browse</a>
        <a class="btn" href="/submit.html">Post your channel</a>
      </div>
      <div class="navlinks">
        <a class="btn" href="/login.html" id="loginLink">Login</a>
        <a class="btn" href="/logout.html" id="logoutLink" style="display:none;">Logout</a>
      </div>
    </nav>
  </div>
</header>

<main class="wrap">
  <div class="card" id="top">
    <div class="small">Loading…</div>
  </div>

  <div style="height:12px"></div>

  <div class="card">
    <h2>Comments</h2>
    <div class="small" id="commentHint"></div>
    <div style="height:8px"></div>

    <div id="commentBox" style="display:none;">
      <textarea id="body" rows="4" placeholder="Say something supportive or helpful…"></textarea>
      <div style="height:10px"></div>
      <button class="btn primary" id="post" type="button">Post comment</button>
    </div>

    <hr>
    <div id="comments"></div>
  </div>
</main>

<script src="/assets/app.js"></script>
<script>
document.addEventListener("DOMContentLoaded", async () => {
  const top = document.querySelector("#top");

  const showError = (msg) => {
    top.innerHTML = `
      <div class="small">Error: ${APP.escapeHtml(msg)}</div>
      <div style="margin-top:10px; display:flex; gap:10px; flex-wrap:wrap;">
        <a class="btn" href="/browse.html">Back to browse</a>
        <a class="btn" href="/submit.html">Post your channel</a>
      </div>
    `;
  };

  try {
    // nav login/logout
    const userNav = await APP.getMe().catch(()=>null);
    if (userNav) {
      const a = document.querySelector("#loginLink"); if (a) a.style.display="none";
      const b = document.querySelector("#logoutLink"); if (b) b.style.display="inline-block";
    }

    const url = new URL(location.href);
    const id = url.searchParams.get("id");
    if (!id) return showError("Missing channel id (URL should look like /channel.html?id=xxxx).");

    const chRes = await APP.api("/api/channels/" + encodeURIComponent(id), { method: "GET" });
    const ch = chRes.channel;

    document.title = ch.display_name + " • Mission Channels";

    top.innerHTML = `
      <div class="small">${APP.escapeHtml(ch.category)}${ch.location ? " • " + APP.escapeHtml(ch.location) : ""}</div>
      <h1 style="margin:8px 0 6px;">${APP.escapeHtml(ch.display_name)}</h1>
      <p class="small" style="font-size:14px; line-height:1.5;">${APP.escapeHtml(ch.mission)}</p>

      <div style="display:flex; gap:10px; flex-wrap:wrap; margin-top:10px;">
        <a class="btn primary" href="${APP.escapeHtml(ch.youtube_url)}" target="_blank" rel="noopener">Visit on YouTube</a>
        <a class="btn" href="/browse.html">Back to browse</a>
        <button class="btn" id="deleteBtn" type="button" style="display:none;">Delete post</button>
      </div>

      <div class="small" id="ownerMsg" style="margin-top:8px;"></div>
    `;

    // If logged in, show comment UI and maybe delete button
    const user = await APP.getMe().catch(() => null);
    const hint = document.querySelector("#commentHint");
    const box = document.querySelector("#commentBox");

    if (!user) {
      hint.innerHTML = `Login to comment. <a href="/login.html">Go to login</a>`;
      box.style.display = "none";
    } else {
      hint.textContent = "Be respectful. Support the mission.";
      box.style.display = "block";

      // Owner check: backend returns channel.user_id, /api/auth/me returns user.id (same as sub)
      // In your earlier /api/auth/me response, you had user.id available.
    const isOwner = me && ch.user_id && me.sub === ch.user_id;

      if (isOwner) {
        const del = document.querySelector("#deleteBtn");
        del.style.display = "inline-block";
        document.querySelector("#ownerMsg").textContent = "You own this post. You can delete it.";

        del.addEventListener("click", async () => {
          if (!confirm("Delete this post? This cannot be undone.")) return;
          try {
            await APP.api("/api/channels/" + encodeURIComponent(id), { method: "DELETE" });
            location.href = "/browse.html";
          } catch (e) {
            alert(e.message || "Delete failed");
          }
        });
      }
    }

    async function loadComments() {
      const data = await APP.api("/api/comments?channel_id=" + encodeURIComponent(id), { method: "GET" });
      const el = document.querySelector("#comments");
      const items = data.comments || [];
      el.innerHTML = items.map(c => `
        <div class="card" style="margin-bottom:10px;">
          <div class="small">${c.author_email ? APP.escapeHtml(c.author_email) : "Anonymous"} • ${new Date(c.created_at).toLocaleString()}</div>
          <div style="margin-top:8px;">${APP.escapeHtml(c.body)}</div>
        </div>
      `).join("") || `<div class="small">No comments yet.</div>`;
    }

    document.querySelector("#post").addEventListener("click", async () => {
      const body = document.querySelector("#body").value.trim();
      if (!body) return;
      await APP.api("/api/comments", {
        method: "POST",
        body: JSON.stringify({ channel_id: id, body })
      });
      document.querySelector("#body").value = "";
      loadComments();
    });

    loadComments();
  } catch (e) {
    console.error(e);
    showError(e.message || String(e));
  }
});
</script>
</body>
</html>
