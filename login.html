<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Login â€¢ Mission Channels</title>
  <link rel="stylesheet" href="/assets/style.css">
</head>
<body>
<header>
  <div class="wrap">
    <nav>
      <div class="navlinks">
        <a class="btn" href="/">Mission Channels</a>
        <a class="btn" href="/browse.html">Browse</a>
        <a class="btn" href="/submit.html">Post your channel</a>
      </div>
    </nav>
  </div>
</header>

<main class="wrap">
  <h1>Login or Sign Up</h1>
  <div class="row">
    
    <div class="card">
      <h2>Create Account</h2>
      <label>Username</label>
      <input id="su_username" placeholder="Choose a username" />
      <label>Password (6+ characters)</label>
      <input id="su_password" type="password" placeholder="Choose a password" />
      <div style="height:12px"></div>
      <button class="btn primary" id="signup">Sign Up</button>
      <div class="small" id="su_msg" style="margin-top:8px;"></div>
    </div>

    <div class="card">
      <h2>Login</h2>
      <label>Username</label>
      <input id="li_username" placeholder="Your username" />
      <label>Password</label>
      <input id="li_password" type="password" placeholder="Your password" />
      <div style="height:12px"></div>
      <button class="btn primary" id="login">Login</button>
      <div class="small" id="li_msg" style="margin-top:8px;"></div>
    </div>

  </div>
</main>

<script src="/assets/app.js"></script>
<script>
document.addEventListener("DOMContentLoaded", async () => {
  
  // Check if already logged in
  const user = await APP.getMe().catch(() => null);
  if (user) {
    location.href = "/browse.html";
    return;
  }

  // Signup handler
  document.querySelector("#signup").addEventListener("click", async () => {
    const msg = document.querySelector("#su_msg");
    msg.textContent = "";
    
    const username = document.querySelector("#su_username").value.trim();
    const password = document.querySelector("#su_password").value;

    try {
      await APP.api("/api/auth/signup", {
        method: "POST",
        body: JSON.stringify({ username, password })
      });
      location.href = "/browse.html";
    } catch (e) {
      msg.textContent = e.message;
    }
  });

  // Login handler
  document.querySelector("#login").addEventListener("click", async () => {
    const msg = document.querySelector("#li_msg");
    msg.textContent = "";

    const username = document.querySelector("#li_username").value.trim();
    const password = document.querySelector("#li_password").value;

    try {
      await APP.api("/api/auth/login", {
        method: "POST",
        body: JSON.stringify({ username, password })
      });
      location.href = "/browse.html";
    } catch (e) {
      msg.textContent = e.message;
    }
  });

});
</script>
</body>
</html>
